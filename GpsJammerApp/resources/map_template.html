<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Mapa GPS Jamming Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <style>
    html, body, #map {{ height: 100%; margin: 0; }}
    .info {{
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }}

    /* Szersza legenda, żeby tekst się nie zawijał zbyt wcześnie */
    .info.legend {{
      min-width: 220px;    /* ustaw minimalną szerokość legendy */
      max-width: 360px;    /* ogranicz maksymalną szerokość */
      white-space: normal; /* pozwól na naturalne łamanie linii, ale rzadziej */
      word-break: normal;
    }}
    .legend-item{{
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }}

    .legend {{
      line-height: 18px;
      color: #555;
    }}
    .legend i {{
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      margin-right: 12px; /* nieco więcej odstępu między ikoną a tekstem */
      opacity: 0.9;
    }}

    @media (max-width: 480px) {{
      .info.legend {{ min-width: 160px; max-width: 260px; font-size: 13px; }}
      .legend i {{ margin-right: 8px; }}
    }}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const lat = {LAT};
    const lng = {LNG};
    const zoom = {ZOOM};
    const map = L.map('map').setView([lat, lng], zoom);

    const osmLayer = L.tileLayer('https://{{s}}.tile.openstreetmap.org/{{z}}/{{x}}/{{y}}.png', {{
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }});
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{{z}}/{{y}}/{{x}}', {{
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri'
    }});
    const topoLayer = L.tileLayer('https://{{s}}.tile.opentopomap.org/{{z}}/{{x}}/{{y}}.png', {{
      maxZoom: 17,
      attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
    }});
    osmLayer.addTo(map);

    // Kontrola warstw
    const baseMaps = {{
      "OpenStreetMap": osmLayer,
      "Satelitarna": satelliteLayer,
      "Topograficzna": topoLayer
    }};

    L.control.layers(baseMaps).addTo(map);

    // Marker główny
    const mainMarker = L.marker([lat, lng]).addTo(map)
      .bindPopup(`<b>Aktualna lokalizacja</b><br>Lat: ${{lat.toFixed(5)}}<br>Lng: ${{lng.toFixed(5)}}`)
      .openPopup();

    let signalMarkers = [];
    let jammingZones = [];
    
    let liveMarker = null;
    let livePolyline = null;

    function clearSignalMarkers() {{
      signalMarkers.forEach(marker => map.removeLayer(marker));
      signalMarkers = [];
      
      if (liveMarker) {{
        map.removeLayer(liveMarker);
        liveMarker = null;
      }}
      if (livePolyline) {{
        map.removeLayer(livePolyline);
        livePolyline = null;
      }}
    }}

    function changeMapLayer(layerName) {{
      map.eachLayer(function(layer) {{
        if (layer._url) map.removeLayer(layer);
      }});
      
      switch(layerName) {{
        case 'osm':
          osmLayer.addTo(map);
          break;
        case 'satellite':
          satelliteLayer.addTo(map);
          break;
        case 'topo':
          topoLayer.addTo(map);
          break;
      }}
    }}
    
    function updateLivePosition(lat, lng) {{
      const newPos = [lat, lng];
      
      if (!liveMarker) {{
        liveMarker = L.circleMarker(newPos, {{
          color: '#3388ff',
          fillColor: '#3388ff',
          fillOpacity: 0.8,
          radius: 10,
          weight: 3
        }}).addTo(map);

        liveMarker.bindPopup(`
            <b>Aktualna lokalizacja:</b><br>
            Szerokość geograficzna: ${{lat.toFixed(7)}}<br>
            Długość geograficzna: ${{lng.toFixed(7)}}
        `).openPopup();
          
      }} else {{
        liveMarker.setLatLng(newPos);
        liveMarker.setPopupContent(`
            <b>Aktualna lokalizacja:</b><br>
            Szerokość geograficzna: ${{lat.toFixed(7)}}<br>
            Długość geograficzna: ${{lng.toFixed(7)}}
        `);
      }}
      
      if (!livePolyline) {{
        livePolyline = L.polyline([newPos], {{
          color: '#3388ff',
          weight: 6,
          opacity: 0.7
        }}).addTo(map);
      }} else {{
        livePolyline.addLatLng(newPos);
      }}
      
      map.panTo(newPos);
    }}

    // Legenda
    const legend = L.control({{position: 'bottomright'}});
    legend.onAdd = function (map) {{
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `
      <h4>Legenda</h4>
      <div class="legend-item"><i style="background:red; border-radius: 50%;"></i> Lokalizacja jammera</div>
      <div class="legend-item"><i style="background:red; opacity: 0.3; border: 2px solid red;"></i> Szacowana odległość</div>
      <div class="legend-item"><i style="background:#3388ff; border-radius: 50%;"></i> Zdekodowana pozycja</div>
      `;
      return div;
    }};
    legend.addTo(map);

    window.clearSignalMarkers = clearSignalMarkers;
    window.changeMapLayer = changeMapLayer;
    window.updateLivePosition = updateLivePosition;
  </script>
</body>
</html>